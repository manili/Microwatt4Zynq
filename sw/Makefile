# Output Zip File Name
ZIP_NAME = sw_package.zip

# Directories
MW_DIR = mw_welcome
PS_DIR = ps_bootloader
SD_DIR = $(PS_DIR)/sd_card_driver

# File generated by the mw_welcome Makefile
HEX_FILE = $(MW_DIR)/mw_welcome_c_ver.hex

# Files from ps_bootloader folder
BOOT_FILES = $(PS_DIR)/bootloader.c

# Files from sd_card_driver folder
SD_FILES = $(SD_DIR)/xsdps.c \
           $(SD_DIR)/xsdps_card.c \
           $(SD_DIR)/xsdps_core.h \
           $(SD_DIR)/xsdps_g.c \
           $(SD_DIR)/xsdps.h \
           $(SD_DIR)/xsdps_host.c \
           $(SD_DIR)/xsdps_hw.h \
           $(SD_DIR)/xsdps_options.c \
           $(SD_DIR)/xsdps_sinit.c

# Combine all files into one list
FILES_TO_ZIP = $(HEX_FILE) $(BOOT_FILES) $(SD_FILES)

.PHONY: all clean

all: $(ZIP_NAME)

# 1. Build the hex file by calling the sub-makefile
# 2. Create the zip with -j (junk paths) to ensure flat structure
# 3. Clean the sub-directory artifacts immediately after zipping
$(ZIP_NAME): $(HEX_FILE)
	zip -j $@ $(FILES_TO_ZIP)
	$(MAKE) -C $(MW_DIR) clean

# Rule to generate the hex file using the existing Makefile in mw_welcome
$(HEX_FILE):
	$(MAKE) -C $(MW_DIR) mw_welcome.hex

# Clean target for this Makefile (removes the generated zip)
clean:
	rm -f $(ZIP_NAME)
